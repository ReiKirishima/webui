{"file":"/Users/macbook/karpov-work/TrueNAS/webui/src/app/pages/system/advanced/cron/cron-card/cron-card.component.ts","mappings":"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","names":[],"sources":["/Users/macbook/karpov-work/TrueNAS/webui/src/app/pages/system/advanced/cron/cron-card/cron-card.component.ts"],"sourcesContent":["import { AsyncPipe } from '@angular/common';\nimport {\n  ChangeDetectionStrategy, Component, OnInit,\n} from '@angular/core';\nimport { MatButton } from '@angular/material/button';\nimport { MatCard } from '@angular/material/card';\nimport { MatDialog } from '@angular/material/dialog';\nimport { MatToolbarRow } from '@angular/material/toolbar';\nimport { RouterLink } from '@angular/router';\nimport { UntilDestroy, untilDestroyed } from '@ngneat/until-destroy';\nimport { TranslateService, TranslateModule } from '@ngx-translate/core';\nimport {\n  filter, map, switchMap, tap,\n} from 'rxjs';\nimport { RequiresRolesDirective } from 'app/directives/requires-roles/requires-roles.directive';\nimport { UiSearchDirective } from 'app/directives/ui-search.directive';\nimport { Role } from 'app/enums/role.enum';\nimport { helptextSystemAdvanced } from 'app/helptext/system/advanced';\nimport { DialogService } from 'app/modules/dialog/dialog.service';\nimport { EmptyService } from 'app/modules/empty/empty.service';\nimport { iconMarker } from 'app/modules/ix-icon/icon-marker.util';\nimport { IxIconComponent } from 'app/modules/ix-icon/ix-icon.component';\nimport { AsyncDataProvider } from 'app/modules/ix-table/classes/async-data-provider/async-data-provider';\nimport { IxTableComponent } from 'app/modules/ix-table/components/ix-table/ix-table.component';\nimport { actionsColumn } from 'app/modules/ix-table/components/ix-table-body/cells/ix-cell-actions/ix-cell-actions.component';\nimport { relativeDateColumn } from 'app/modules/ix-table/components/ix-table-body/cells/ix-cell-relative-date/ix-cell-relative-date.component';\nimport { scheduleColumn } from 'app/modules/ix-table/components/ix-table-body/cells/ix-cell-schedule/ix-cell-schedule.component';\nimport { textColumn } from 'app/modules/ix-table/components/ix-table-body/cells/ix-cell-text/ix-cell-text.component';\nimport { yesNoColumn } from 'app/modules/ix-table/components/ix-table-body/cells/ix-cell-yes-no/ix-cell-yes-no.component';\nimport { IxTableBodyComponent } from 'app/modules/ix-table/components/ix-table-body/ix-table-body.component';\nimport { IxTableHeadComponent } from 'app/modules/ix-table/components/ix-table-head/ix-table-head.component';\nimport { IxTableEmptyDirective } from 'app/modules/ix-table/directives/ix-table-empty.directive';\nimport { createTable } from 'app/modules/ix-table/utils';\nimport { scheduleToCrontab } from 'app/modules/scheduler/utils/schedule-to-crontab.utils';\nimport { TestDirective } from 'app/modules/test-id/test.directive';\nimport { AdvancedSettingsService } from 'app/pages/system/advanced/advanced-settings.service';\nimport { cronCardElements } from 'app/pages/system/advanced/cron/cron-card/cron-card.elements';\nimport { CronDeleteDialogComponent } from 'app/pages/system/advanced/cron/cron-delete-dialog/cron-delete-dialog.component';\nimport { CronFormComponent } from 'app/pages/system/advanced/cron/cron-form/cron-form.component';\nimport { CronjobRow } from 'app/pages/system/advanced/cron/cron-list/cronjob-row.interface';\nimport { ErrorHandlerService } from 'app/services/error-handler.service';\nimport { IxChainedSlideInService } from 'app/services/ix-chained-slide-in.service';\nimport { TaskService } from 'app/services/task.service';\nimport { WebSocketService } from 'app/services/ws.service';\n\n@UntilDestroy()\n@Component({\n  selector: 'ix-cron-card',\n  templateUrl: './cron-card.component.html',\n  styleUrls: ['./cron-card.component.scss'],\n  changeDetection: ChangeDetectionStrategy.OnPush,\n  standalone: true,\n  imports: [\n    MatCard,\n    MatToolbarRow,\n    TestDirective,\n    RouterLink,\n    IxIconComponent,\n    RequiresRolesDirective,\n    MatButton,\n    UiSearchDirective,\n    IxTableComponent,\n    IxTableEmptyDirective,\n    IxTableHeadComponent,\n    IxTableBodyComponent,\n    TranslateModule,\n    AsyncPipe,\n  ],\n})\nexport class CronCardComponent implements OnInit {\n  readonly requiredRoles = [Role.FullAdmin];\n  protected readonly searchableElements = cronCardElements;\n\n  title = helptextSystemAdvanced.fieldset_cron;\n  cronjobs: CronjobRow[] = [];\n  dataProvider: AsyncDataProvider<CronjobRow>;\n\n  columns = createTable<CronjobRow>([\n    textColumn({\n      title: this.translate.instant('Users'),\n      propertyName: 'user',\n    }),\n    textColumn({\n      title: this.translate.instant('Command'),\n      propertyName: 'command',\n    }),\n    textColumn({\n      title: this.translate.instant('Description'),\n      propertyName: 'description',\n    }),\n    scheduleColumn({\n      title: this.translate.instant('Schedule'),\n      propertyName: 'schedule',\n    }),\n    yesNoColumn({\n      title: this.translate.instant('Enabled'),\n      propertyName: 'enabled',\n    }),\n    relativeDateColumn({\n      title: this.translate.instant('Next Run'),\n      getValue: (row) => (row.enabled\n        ? this.taskService.getTaskNextTime(row.cron_schedule)\n        : this.translate.instant('Disabled')),\n    }),\n    actionsColumn({\n      cssClass: 'tight-actions',\n      actions: [\n        {\n          iconName: iconMarker('mdi-play-circle'),\n          tooltip: this.translate.instant('Run job'),\n          onClick: (row) => this.runNow(row),\n          requiredRoles: this.requiredRoles,\n        },\n        {\n          iconName: iconMarker('edit'),\n          tooltip: this.translate.instant('Edit'),\n          onClick: (row) => this.doEdit(row),\n        },\n        {\n          iconName: iconMarker('mdi-delete'),\n          tooltip: this.translate.instant('Delete'),\n          onClick: (row) => this.doDelete(row),\n          requiredRoles: this.requiredRoles,\n        },\n      ],\n    }),\n  ], {\n    uniqueRowTag: (row) => 'card-cron-' + row.command + '-' + row.user,\n    ariaLabels: (row) => [row.command, this.translate.instant('Cron Job')],\n  });\n\n  constructor(\n    private translate: TranslateService,\n    private errorHandler: ErrorHandlerService,\n    private ws: WebSocketService,\n    private dialog: DialogService,\n    private taskService: TaskService,\n    private matDialog: MatDialog,\n    private advancedSettings: AdvancedSettingsService,\n    protected emptyService: EmptyService,\n    private chainedSlideIns: IxChainedSlideInService,\n  ) {}\n\n  ngOnInit(): void {\n    const cronjobs$ = this.ws.call('cronjob.query').pipe(\n      map((cronjobs) => {\n        return cronjobs.map((job): CronjobRow => ({\n          ...job,\n          cron_schedule: scheduleToCrontab(job.schedule),\n          next_run: this.taskService.getTaskNextRun(scheduleToCrontab(job.schedule)),\n        }));\n      }),\n      tap((cronjobs) => this.cronjobs = cronjobs),\n      untilDestroyed(this),\n    );\n    this.dataProvider = new AsyncDataProvider<CronjobRow>(cronjobs$);\n    this.getCronJobs();\n  }\n\n  onAdd(): void {\n    this.openForm();\n  }\n\n  getCronJobs(): void {\n    this.dataProvider.load();\n  }\n\n  runNow(row: CronjobRow): void {\n    this.dialog.confirm({\n      title: this.translate.instant('Run Now'),\n      message: this.translate.instant('Run this job now?'),\n      hideCheckbox: true,\n    }).pipe(\n      filter(Boolean),\n      switchMap(() => this.ws.call('cronjob.run', [row.id])),\n      untilDestroyed(this),\n    ).subscribe({\n      next: () => {\n        const message = row.enabled\n          ? this.translate.instant('This job is scheduled to run again {nextRun}.', { nextRun: row.next_run })\n          : this.translate.instant('This job will not run again until it is enabled.');\n        this.dialog.info(\n          this.translate.instant('Job {job} Completed Successfully', { job: row.description }),\n          message,\n        );\n      },\n      error: (error: unknown) => this.dialog.error(this.errorHandler.parseError(error)),\n    });\n  }\n\n  doDelete(row: CronjobRow): void {\n    this.matDialog.open(CronDeleteDialogComponent, {\n      data: row,\n    }).afterClosed()\n      .pipe(filter(Boolean), untilDestroyed(this))\n      .subscribe(() => {\n        this.getCronJobs();\n      });\n  }\n\n  doEdit(row: CronjobRow): void {\n    this.openForm(row);\n  }\n\n  private openForm(row?: CronjobRow): void {\n    this.advancedSettings.showFirstTimeWarningIfNeeded().pipe(\n      switchMap(() => this.chainedSlideIns.open(CronFormComponent, false, row)),\n      filter((response) => !!response.response),\n      untilDestroyed(this),\n    ).subscribe({\n      next: () => {\n        this.getCronJobs();\n      },\n    });\n  }\n}\n"],"version":3}