0145ac30e5b8e16a4a74dbbb319a3aa9
"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ApplicationsService = void 0;
exports.filterIgnoredApps = filterIgnoredApps;
const core_1 = require("@angular/core");
const core_2 = require("@ngx-translate/core");
const rxjs_1 = require("rxjs");
const catalog_constants_1 = require("app/constants/catalog.constants");
const app_extra_category_enum_1 = require("app/enums/app-extra-category.enum");
const ws_service_1 = require("app/services/ws.service");
const ignoredAppsList = [catalog_constants_1.customApp];
function filterIgnoredApps() {
    return (0, rxjs_1.pipe)((0, rxjs_1.map)((apps) => apps.filter((app) => !ignoredAppsList.includes(app.name))));
}
let ApplicationsService = class ApplicationsService {
    constructor(ws, translate) {
        this.ws = ws;
        this.translate = translate;
    }
    getPoolList() {
        return this.ws.call('pool.query');
    }
    getInterfaces() {
        return this.ws.call('interface.query');
    }
    getCatalogAppDetails(name, train) {
        return this.ws.call('catalog.get_app_details', [name, { train }]);
    }
    getAllAppsCategories() {
        return this.ws.call('app.categories');
    }
    getLatestApps(filters) {
        return this.getAppsFetchCall('app.latest', filters).pipe(filterIgnoredApps());
    }
    getAvailableApps(filters) {
        return this.getAppsFetchCall('app.available', filters).pipe(filterIgnoredApps());
    }
    getSimilarApps(app) {
        return this.ws.call('app.similar', [app.name, app.train]);
    }
    getAllApps() {
        return this.ws.call('app.query', [[], { extra: { retrieve_config: true } }]).pipe((0, rxjs_1.shareReplay)({ bufferSize: 1, refCount: true }));
    }
    getApp(name) {
        return this.ws.call('app.query', [[['name', '=', name]], {
                extra: {
                    include_app_schema: true,
                    retrieve_config: true,
                },
            }]);
    }
    getInstalledAppsUpdates() {
        return this.ws.subscribe('app.query');
    }
    getInstalledAppsStatusUpdates() {
        return this.ws.subscribe('core.get_jobs').pipe((0, rxjs_1.filter)((event) => {
            return ['app.start', 'app.stop'].includes(event.fields.method);
        }));
    }
    getAppUpgradeSummary(name, version) {
        const payload = [name];
        if (version) {
            payload.push({ app_version: version });
        }
        return this.ws.call('app.upgrade_summary', payload);
    }
    startApplication(name) {
        return this.ws.job('app.start', [name]);
    }
    stopApplication(name) {
        return this.ws.job('app.stop', [name]);
    }
    restartApplication(name) {
        return this.ws.job('app.redeploy', [name]);
    }
    convertDateToRelativeDate(date) {
        const diff = Math.round((Number(new Date()) - Number(date)) / 1000);
        const day = 60 * 60 * 24;
        if (diff < day) {
            return this.translate.instant('Last 24 hours');
        }
        if (diff < day * 3) {
            return this.translate.instant('Last 3 days');
        }
        if (diff < day * 14) {
            return this.translate.instant('Last week');
        }
        if (diff < day * 60) {
            return this.translate.instant('Last month');
        }
        return this.translate.instant('Long time ago');
    }
    getAppsFetchCall(endPoint, filters) {
        var _a, _b, _c, _d, _e;
        if (filters && !((_a = filters.categories) === null || _a === void 0 ? void 0 : _a.length)) {
            delete filters.categories;
        }
        if (filters && !((_b = filters.sort) === null || _b === void 0 ? void 0 : _b.length)) {
            delete filters.sort;
        }
        if (!filters || (filters && !Object.keys(filters).length)) {
            return this.ws.call(endPoint).pipe(filterIgnoredApps());
        }
        const firstOption = [];
        if ((_c = filters.categories) === null || _c === void 0 ? void 0 : _c.includes(app_extra_category_enum_1.AppExtraCategory.Recommended)) {
            firstOption.push(['recommended', '=', true]);
        }
        filters.categories = (_d = filters.categories) === null || _d === void 0 ? void 0 : _d.filter((category) => !(category === null || category === void 0 ? void 0 : category.includes(app_extra_category_enum_1.AppExtraCategory.Recommended)));
        if ((_e = filters.categories) === null || _e === void 0 ? void 0 : _e.length) {
            firstOption.push(['OR', filters.categories.map((category) => ['categories', 'rin', category])]);
        }
        const secondOption = filters.sort ? { order_by: [filters.sort] } : {};
        return this.ws.call(endPoint, [firstOption, secondOption]).pipe(filterIgnoredApps());
    }
};
exports.ApplicationsService = ApplicationsService;
ApplicationsService.ctorParameters = () => [
    { type: ws_service_1.WebSocketService },
    { type: core_2.TranslateService }
];
exports.ApplicationsService = ApplicationsService = __decorate([
    (0, core_1.Injectable)({ providedIn: 'root' })
], ApplicationsService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3BhZ2VzL2FwcHMvc2VydmljZXMvYXBwbGljYXRpb25zLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBd0JBLDhDQUlDO0FBNUJELHdDQUEyQztBQUMzQyw4Q0FBdUQ7QUFDdkQsK0JBR2M7QUFDZCx1RUFBNEQ7QUFDNUQsK0VBQXFFO0FBYXJFLHdEQUEyRDtBQUUzRCxNQUFNLGVBQWUsR0FBRyxDQUFDLDZCQUFTLENBQUMsQ0FBQztBQUVwQyxTQUFnQixpQkFBaUI7SUFDL0IsT0FBTyxJQUFBLFdBQUksRUFDVCxJQUFBLFVBQUcsRUFBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQ3pFLENBQUM7QUFDSixDQUFDO0FBR00sSUFBTSxtQkFBbUIsR0FBekIsTUFBTSxtQkFBbUI7SUFDOUIsWUFBb0IsRUFBb0IsRUFBVSxTQUEyQjtRQUF6RCxPQUFFLEdBQUYsRUFBRSxDQUFrQjtRQUFVLGNBQVMsR0FBVCxTQUFTLENBQWtCO0lBQUcsQ0FBQztJQUVqRixXQUFXO1FBQ1QsT0FBTyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQsYUFBYTtRQUNYLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRUQsb0JBQW9CLENBQUMsSUFBWSxFQUFFLEtBQWE7UUFDOUMsT0FBTyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNwRSxDQUFDO0lBRUQsb0JBQW9CO1FBQ2xC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LEVBQUUsUUFBUSxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUV0RSxPQUFPLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLENBQUM7SUFDdkYsQ0FBQzs7QUF4SFUsa0RBQW1COzs7Ozs4QkFBbkIsbUJBQW1CO0lBRC9CLElBQUEsaUJBQVUsRUFBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsQ0FBQztHQUN0QixtQkFBbUIsQ0F5SC9CIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYWNib29rL2thcnBvdi13b3JrL1RydWVOQVMvd2VidWkvc3JjL2FwcC9wYWdlcy9hcHBzL3NlcnZpY2VzL2FwcGxpY2F0aW9ucy5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7XG4gIE9ic2VydmFibGUsIE9wZXJhdG9yRnVuY3Rpb24sIGZpbHRlciwgbWFwLCBwaXBlLFxuICBzaGFyZVJlcGxheSxcbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjdXN0b21BcHAgfSBmcm9tICdhcHAvY29uc3RhbnRzL2NhdGFsb2cuY29uc3RhbnRzJztcbmltcG9ydCB7IEFwcEV4dHJhQ2F0ZWdvcnkgfSBmcm9tICdhcHAvZW51bXMvYXBwLWV4dHJhLWNhdGVnb3J5LmVudW0nO1xuaW1wb3J0IHsgQXBpRXZlbnQgfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9hcGktbWVzc2FnZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHtcbiAgQXBwLCBBcHBTdGFydFF1ZXJ5UGFyYW1zLCBBcHBVcGdyYWRlUGFyYW1zLFxufSBmcm9tICdhcHAvaW50ZXJmYWNlcy9hcHAuaW50ZXJmYWNlJztcbmltcG9ydCB7IEFwcFVwZ3JhZGVTdW1tYXJ5IH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvYXBwbGljYXRpb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IEFwcHNGaWx0ZXJzVmFsdWVzIH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvYXBwcy1maWx0ZXJzLXZhbHVlcy5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQXZhaWxhYmxlQXBwIH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvYXZhaWxhYmxlLWFwcC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQ2F0YWxvZ0FwcCB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL2NhdGFsb2cuaW50ZXJmYWNlJztcbmltcG9ydCB7IEpvYiB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL2pvYi5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgTmV0d29ya0ludGVyZmFjZSB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL25ldHdvcmstaW50ZXJmYWNlLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb29sIH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvcG9vbC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUXVlcnlGaWx0ZXJzIH0gZnJvbSAnYXBwL2ludGVyZmFjZXMvcXVlcnktYXBpLmludGVyZmFjZSc7XG5pbXBvcnQgeyBXZWJTb2NrZXRTZXJ2aWNlIH0gZnJvbSAnYXBwL3NlcnZpY2VzL3dzLnNlcnZpY2UnO1xuXG5jb25zdCBpZ25vcmVkQXBwc0xpc3QgPSBbY3VzdG9tQXBwXTtcblxuZXhwb3J0IGZ1bmN0aW9uIGZpbHRlcklnbm9yZWRBcHBzKCk6IE9wZXJhdG9yRnVuY3Rpb248QXZhaWxhYmxlQXBwW10sIEF2YWlsYWJsZUFwcFtdPiB7XG4gIHJldHVybiBwaXBlKFxuICAgIG1hcCgoYXBwcykgPT4gYXBwcy5maWx0ZXIoKGFwcCkgPT4gIWlnbm9yZWRBcHBzTGlzdC5pbmNsdWRlcyhhcHAubmFtZSkpKSxcbiAgKTtcbn1cblxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBBcHBsaWNhdGlvbnNTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSB3czogV2ViU29ja2V0U2VydmljZSwgcHJpdmF0ZSB0cmFuc2xhdGU6IFRyYW5zbGF0ZVNlcnZpY2UpIHt9XG5cbiAgZ2V0UG9vbExpc3QoKTogT2JzZXJ2YWJsZTxQb29sW10+IHtcbiAgICByZXR1cm4gdGhpcy53cy5jYWxsKCdwb29sLnF1ZXJ5Jyk7XG4gIH1cblxuICBnZXRJbnRlcmZhY2VzKCk6IE9ic2VydmFibGU8TmV0d29ya0ludGVyZmFjZVtdPiB7XG4gICAgcmV0dXJuIHRoaXMud3MuY2FsbCgnaW50ZXJmYWNlLnF1ZXJ5Jyk7XG4gIH1cblxuICBnZXRDYXRhbG9nQXBwRGV0YWlscyhuYW1lOiBzdHJpbmcsIHRyYWluOiBzdHJpbmcpOiBPYnNlcnZhYmxlPENhdGFsb2dBcHA+IHtcbiAgICByZXR1cm4gdGhpcy53cy5jYWxsKCdjYXRhbG9nLmdldF9hcHBfZGV0YWlscycsIFtuYW1lLCB7IHRyYWluIH1dKTtcbiAgfVxuXG4gIGdldEFsbEFwcHNDYXRlZ29yaWVzKCk6IE9ic2VydmFibGU8c3RyaW5nW10+IHtcbiAgICByZXR1cm4gdGhpcy53cy5jYWxsKCdhcHAuY2F0ZWdvcmllcycpO1xuICB9XG5cbiAgZ2V0TGF0ZXN0QXBwcyhmaWx0ZXJzPzogQXBwc0ZpbHRlcnNWYWx1ZXMpOiBPYnNlcnZhYmxlPEF2YWlsYWJsZUFwcFtdPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0QXBwc0ZldGNoQ2FsbCgnYXBwLmxhdGVzdCcsIGZpbHRlcnMpLnBpcGUoZmlsdGVySWdub3JlZEFwcHMoKSk7XG4gIH1cblxuICBnZXRBdmFpbGFibGVBcHBzKGZpbHRlcnM/OiBBcHBzRmlsdGVyc1ZhbHVlcyk6IE9ic2VydmFibGU8QXZhaWxhYmxlQXBwW10+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRBcHBzRmV0Y2hDYWxsKCdhcHAuYXZhaWxhYmxlJywgZmlsdGVycykucGlwZShmaWx0ZXJJZ25vcmVkQXBwcygpKTtcbiAgfVxuXG4gIGdldFNpbWlsYXJBcHBzKGFwcDogQXZhaWxhYmxlQXBwKTogT2JzZXJ2YWJsZTxBdmFpbGFibGVBcHBbXT4ge1xuICAgIHJldHVybiB0aGlzLndzLmNhbGwoJ2FwcC5zaW1pbGFyJywgW2FwcC5uYW1lLCBhcHAudHJhaW5dKTtcbiAgfVxuXG4gIGdldEFsbEFwcHMoKTogT2JzZXJ2YWJsZTxBcHBbXT4ge1xuICAgIHJldHVybiB0aGlzLndzLmNhbGwoJ2FwcC5xdWVyeScsIFtbXSwgeyBleHRyYTogeyByZXRyaWV2ZV9jb25maWc6IHRydWUgfSB9XSkucGlwZShcbiAgICAgIHNoYXJlUmVwbGF5KHsgYnVmZmVyU2l6ZTogMSwgcmVmQ291bnQ6IHRydWUgfSksXG4gICAgKTtcbiAgfVxuXG4gIGdldEFwcChuYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEFwcFtdPiB7XG4gICAgcmV0dXJuIHRoaXMud3MuY2FsbCgnYXBwLnF1ZXJ5JywgW1tbJ25hbWUnLCAnPScsIG5hbWVdXSwge1xuICAgICAgZXh0cmE6IHtcbiAgICAgICAgaW5jbHVkZV9hcHBfc2NoZW1hOiB0cnVlLFxuICAgICAgICByZXRyaWV2ZV9jb25maWc6IHRydWUsXG4gICAgICB9LFxuICAgIH1dKTtcbiAgfVxuXG4gIGdldEluc3RhbGxlZEFwcHNVcGRhdGVzKCk6IE9ic2VydmFibGU8QXBpRXZlbnQ8QXBwPj4ge1xuICAgIHJldHVybiB0aGlzLndzLnN1YnNjcmliZSgnYXBwLnF1ZXJ5Jyk7XG4gIH1cblxuICBnZXRJbnN0YWxsZWRBcHBzU3RhdHVzVXBkYXRlcygpOiBPYnNlcnZhYmxlPEFwaUV2ZW50PEpvYjx2b2lkLCBBcHBTdGFydFF1ZXJ5UGFyYW1zPj4+IHtcbiAgICByZXR1cm4gdGhpcy53cy5zdWJzY3JpYmUoJ2NvcmUuZ2V0X2pvYnMnKS5waXBlKFxuICAgICAgZmlsdGVyKChldmVudDogQXBpRXZlbnQ8Sm9iPHZvaWQsIEFwcFN0YXJ0UXVlcnlQYXJhbXM+PikgPT4ge1xuICAgICAgICByZXR1cm4gWydhcHAuc3RhcnQnLCAnYXBwLnN0b3AnXS5pbmNsdWRlcyhldmVudC5maWVsZHMubWV0aG9kKTtcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICBnZXRBcHBVcGdyYWRlU3VtbWFyeShuYW1lOiBzdHJpbmcsIHZlcnNpb24/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPEFwcFVwZ3JhZGVTdW1tYXJ5PiB7XG4gICAgY29uc3QgcGF5bG9hZDogQXBwVXBncmFkZVBhcmFtcyA9IFtuYW1lXTtcbiAgICBpZiAodmVyc2lvbikge1xuICAgICAgcGF5bG9hZC5wdXNoKHsgYXBwX3ZlcnNpb246IHZlcnNpb24gfSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLndzLmNhbGwoJ2FwcC51cGdyYWRlX3N1bW1hcnknLCBwYXlsb2FkKTtcbiAgfVxuXG4gIHN0YXJ0QXBwbGljYXRpb24obmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxKb2I8dm9pZD4+IHtcbiAgICByZXR1cm4gdGhpcy53cy5qb2IoJ2FwcC5zdGFydCcsIFtuYW1lXSk7XG4gIH1cblxuICBzdG9wQXBwbGljYXRpb24obmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxKb2I8dm9pZD4+IHtcbiAgICByZXR1cm4gdGhpcy53cy5qb2IoJ2FwcC5zdG9wJywgW25hbWVdKTtcbiAgfVxuXG4gIHJlc3RhcnRBcHBsaWNhdGlvbihuYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEpvYjx2b2lkPj4ge1xuICAgIHJldHVybiB0aGlzLndzLmpvYignYXBwLnJlZGVwbG95JywgW25hbWVdKTtcbiAgfVxuXG4gIGNvbnZlcnREYXRlVG9SZWxhdGl2ZURhdGUoZGF0ZTogRGF0ZSk6IHN0cmluZyB7XG4gICAgY29uc3QgZGlmZiA9IE1hdGgucm91bmQoKE51bWJlcihuZXcgRGF0ZSgpKSAtIE51bWJlcihkYXRlKSkgLyAxMDAwKTtcbiAgICBjb25zdCBkYXkgPSA2MCAqIDYwICogMjQ7XG5cbiAgICBpZiAoZGlmZiA8IGRheSkgeyByZXR1cm4gdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnTGFzdCAyNCBob3VycycpOyB9XG4gICAgaWYgKGRpZmYgPCBkYXkgKiAzKSB7IHJldHVybiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KCdMYXN0IDMgZGF5cycpOyB9XG4gICAgaWYgKGRpZmYgPCBkYXkgKiAxNCkgeyByZXR1cm4gdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnTGFzdCB3ZWVrJyk7IH1cbiAgICBpZiAoZGlmZiA8IGRheSAqIDYwKSB7IHJldHVybiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KCdMYXN0IG1vbnRoJyk7IH1cbiAgICByZXR1cm4gdGhpcy50cmFuc2xhdGUuaW5zdGFudCgnTG9uZyB0aW1lIGFnbycpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRBcHBzRmV0Y2hDYWxsKFxuICAgIGVuZFBvaW50OiAnYXBwLmF2YWlsYWJsZScgfCAnYXBwLmxhdGVzdCcsXG4gICAgZmlsdGVycz86IEFwcHNGaWx0ZXJzVmFsdWVzLFxuICApOiBPYnNlcnZhYmxlPEF2YWlsYWJsZUFwcFtdPiB7XG4gICAgaWYgKGZpbHRlcnMgJiYgIWZpbHRlcnMuY2F0ZWdvcmllcz8ubGVuZ3RoKSB7XG4gICAgICBkZWxldGUgZmlsdGVycy5jYXRlZ29yaWVzO1xuICAgIH1cbiAgICBpZiAoZmlsdGVycyAmJiAhZmlsdGVycy5zb3J0Py5sZW5ndGgpIHtcbiAgICAgIGRlbGV0ZSBmaWx0ZXJzLnNvcnQ7XG4gICAgfVxuICAgIGlmICghZmlsdGVycyB8fCAoZmlsdGVycyAmJiAhT2JqZWN0LmtleXMoZmlsdGVycykubGVuZ3RoKSkge1xuICAgICAgcmV0dXJuIHRoaXMud3MuY2FsbChlbmRQb2ludCkucGlwZShmaWx0ZXJJZ25vcmVkQXBwcygpKTtcbiAgICB9XG5cbiAgICBjb25zdCBmaXJzdE9wdGlvbjogUXVlcnlGaWx0ZXJzPEF2YWlsYWJsZUFwcD4gPSBbXTtcblxuICAgIGlmIChmaWx0ZXJzLmNhdGVnb3JpZXM/LmluY2x1ZGVzKEFwcEV4dHJhQ2F0ZWdvcnkuUmVjb21tZW5kZWQpKSB7XG4gICAgICBmaXJzdE9wdGlvbi5wdXNoKFsncmVjb21tZW5kZWQnLCAnPScsIHRydWVdKTtcbiAgICB9XG5cbiAgICBmaWx0ZXJzLmNhdGVnb3JpZXMgPSBmaWx0ZXJzLmNhdGVnb3JpZXM/LmZpbHRlcigoY2F0ZWdvcnkpID0+ICFjYXRlZ29yeT8uaW5jbHVkZXMoQXBwRXh0cmFDYXRlZ29yeS5SZWNvbW1lbmRlZCkpO1xuXG4gICAgaWYgKGZpbHRlcnMuY2F0ZWdvcmllcz8ubGVuZ3RoKSB7XG4gICAgICBmaXJzdE9wdGlvbi5wdXNoKFxuICAgICAgICBbJ09SJywgZmlsdGVycy5jYXRlZ29yaWVzLm1hcCgoY2F0ZWdvcnkpID0+IFsnY2F0ZWdvcmllcycsICdyaW4nLCBjYXRlZ29yeV0pXSBhcyBRdWVyeUZpbHRlcnM8QXZhaWxhYmxlQXBwPixcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3Qgc2Vjb25kT3B0aW9uID0gZmlsdGVycy5zb3J0ID8geyBvcmRlcl9ieTogW2ZpbHRlcnMuc29ydF0gfSA6IHt9O1xuXG4gICAgcmV0dXJuIHRoaXMud3MuY2FsbChlbmRQb2ludCwgW2ZpcnN0T3B0aW9uLCBzZWNvbmRPcHRpb25dKS5waXBlKGZpbHRlcklnbm9yZWRBcHBzKCkpO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=