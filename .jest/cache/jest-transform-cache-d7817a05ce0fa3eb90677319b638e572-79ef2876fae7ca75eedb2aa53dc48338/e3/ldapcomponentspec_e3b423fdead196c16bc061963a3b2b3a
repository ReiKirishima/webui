62b2c1dd5fed33b67805ed6e713e8808
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const testbed_1 = require("@angular/cdk/testing/testbed");
const forms_1 = require("@angular/forms");
const testing_1 = require("@angular/material/button/testing");
const jest_1 = require("@ngneat/spectator/jest");
const rxjs_1 = require("rxjs");
const fake_job_utils_1 = require("app/core/testing/utils/fake-job.utils");
const mock_auth_utils_1 = require("app/core/testing/utils/mock-auth.utils");
const mock_websocket_utils_1 = require("app/core/testing/utils/mock-websocket.utils");
const ldap_1 = require("app/helptext/directory-service/ldap");
const dialog_service_1 = require("app/modules/dialog/dialog.service");
const ix_slide_in_ref_1 = require("app/modules/forms/ix-forms/components/ix-slide-in/ix-slide-in-ref");
const ix_slide_in_token_1 = require("app/modules/forms/ix-forms/components/ix-slide-in/ix-slide-in.token");
const with_manage_certificates_link_component_1 = require("app/modules/forms/ix-forms/components/with-manage-certificates-link/with-manage-certificates-link.component");
const ix_form_harness_1 = require("app/modules/forms/ix-forms/testing/ix-form.harness");
const snackbar_service_1 = require("app/modules/snackbar/services/snackbar.service");
const ldap_component_1 = require("app/pages/directory-service/components/ldap/ldap.component");
const ix_slide_in_service_1 = require("app/services/ix-slide-in.service");
const system_general_service_1 = require("app/services/system-general.service");
const ws_service_1 = require("app/services/ws.service");
describe('LdapComponent', () => {
    let spectator;
    let loader;
    let form;
    const existingLdapConfig = {
        hostname: ['ldap.truenas.com', 'ldap.freenas.org'],
        basedn: 'dc=test,dc=org',
        binddn: 'cn=Manager,dc=test',
        bindpw: '12345678',
        enable: true,
        anonbind: false,
        ssl: 'START_TLS',
        certificate: 1,
        validate_certificates: true,
        disable_freenas_cache: true,
        kerberos_realm: 1,
        kerberos_principal: 'principal1',
        timeout: 10,
        dns_timeout: 15,
        auxiliary_parameters: 'param=25',
        schema: 'RFC2307',
    };
    const createComponent = (0, jest_1.createComponentFactory)({
        component: ldap_component_1.LdapComponent,
        imports: [
            forms_1.ReactiveFormsModule,
            with_manage_certificates_link_component_1.WithManageCertificatesLinkComponent,
        ],
        providers: [
            (0, mock_websocket_utils_1.mockWebSocket)([
                (0, mock_websocket_utils_1.mockJob)('ldap.update', (0, fake_job_utils_1.fakeSuccessfulJob)()),
                (0, mock_websocket_utils_1.mockCall)('ldap.config', existingLdapConfig),
                (0, mock_websocket_utils_1.mockCall)('kerberos.keytab.kerberos_principal_choices', [
                    'principal1', 'principal2',
                ]),
                (0, mock_websocket_utils_1.mockCall)('ldap.ssl_choices', ['OFF', 'START_TLS']),
                (0, mock_websocket_utils_1.mockCall)('ldap.schema_choices', ['RFC2307', 'RFC2307BIS']),
                (0, mock_websocket_utils_1.mockCall)('kerberos.realm.query', [
                    { id: 1, realm: 'Realm 1' },
                    { id: 2, realm: 'Realm 2' },
                ]),
            ]),
            (0, jest_1.mockProvider)(ix_slide_in_service_1.IxSlideInService),
            (0, jest_1.mockProvider)(system_general_service_1.SystemGeneralService, {
                refreshDirServicesCache: jest.fn(() => (0, rxjs_1.of)(null)),
                getCertificates: () => (0, rxjs_1.of)([
                    { id: 1, name: 'certificate1' },
                    { id: 2, name: 'certificate2' },
                ]),
            }),
            (0, jest_1.mockProvider)(dialog_service_1.DialogService, {
                jobDialog: jest.fn(() => ({
                    afterClosed: () => (0, rxjs_1.of)(null),
                })),
            }),
            (0, jest_1.mockProvider)(snackbar_service_1.SnackbarService),
            (0, jest_1.mockProvider)(ix_slide_in_ref_1.IxSlideInRef),
            (0, mock_auth_utils_1.mockAuth)(),
            { provide: ix_slide_in_token_1.SLIDE_IN_DATA, useValue: undefined },
        ],
    });
    beforeEach(() => __awaiter(void 0, void 0, void 0, function* () {
        spectator = createComponent();
        loader = testbed_1.TestbedHarnessEnvironment.loader(spectator.fixture);
        form = yield loader.getHarness(ix_form_harness_1.IxFormHarness);
    }));
    it('loads LDAP config and shows it', () => __awaiter(void 0, void 0, void 0, function* () {
        expect(spectator.inject(ws_service_1.WebSocketService).call).toHaveBeenCalledWith('ldap.config');
        const values = yield form.getValues();
        expect(values).toEqual({
            Hostname: ['ldap.truenas.com', 'ldap.freenas.org'],
            'Base DN': 'dc=test,dc=org',
            'Bind DN': 'cn=Manager,dc=test',
            'Bind Password': '12345678',
            Enable: true,
        });
    }));
    it('shows advanced LDAP when Advanced Mode is pressed', () => __awaiter(void 0, void 0, void 0, function* () {
        const advancedModeButton = yield loader.getHarness(testing_1.MatButtonHarness.with({ text: 'Advanced Options' }));
        yield advancedModeButton.click();
        const values = yield form.getValues();
        expect(values).toEqual({
            Hostname: ['ldap.truenas.com', 'ldap.freenas.org'],
            'Base DN': 'dc=test,dc=org',
            'Bind DN': 'cn=Manager,dc=test',
            'Bind Password': '12345678',
            Enable: true,
            'Allow Anonymous Binding': false,
            'Encryption Mode': 'START_TLS',
            Certificate: 'certificate1',
            'Validate Certificates': true,
            'Disable LDAP User/Group Cache': true,
            'Kerberos Realm': 'Realm 1',
            'Kerberos Principal': 'principal1',
            'LDAP Timeout': '10',
            'DNS Timeout': '15',
            'Auxiliary Parameters': 'param=25',
            Schema: 'RFC2307',
        });
    }));
    it('rebuilds cache when Rebuild Cache button is pressed', () => __awaiter(void 0, void 0, void 0, function* () {
        const rebuildCacheButton = yield loader.getHarness(testing_1.MatButtonHarness.with({ text: 'Rebuild Directory Service Cache' }));
        yield rebuildCacheButton.click();
        expect(spectator.inject(system_general_service_1.SystemGeneralService).refreshDirServicesCache).toHaveBeenCalled();
        expect(spectator.inject(snackbar_service_1.SnackbarService).success).toHaveBeenCalledWith(ldap_1.helptextLdap.ldap_custactions_clearcache_dialog_message);
    }));
    it('saves LDAP config when form is submitted', () => __awaiter(void 0, void 0, void 0, function* () {
        const advancedModeButton = yield loader.getHarness(testing_1.MatButtonHarness.with({ text: 'Advanced Options' }));
        yield advancedModeButton.click();
        yield form.fillForm({
            'Bind Password': 'adminadmin',
            'Allow Anonymous Binding': true,
            'Kerberos Principal': 'principal2',
        });
        const saveButton = yield loader.getHarness(testing_1.MatButtonHarness.with({ text: 'Save' }));
        yield saveButton.click();
        expect(spectator.inject(ws_service_1.WebSocketService).job).toHaveBeenCalledWith('ldap.update', [Object.assign(Object.assign({}, existingLdapConfig), { bindpw: 'adminadmin', anonbind: true, kerberos_principal: 'principal2' })]);
        expect(spectator.inject(dialog_service_1.DialogService).jobDialog).toHaveBeenCalled();
        expect(spectator.inject(ix_slide_in_ref_1.IxSlideInRef).close).toHaveBeenCalled();
    }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3BhZ2VzL2RpcmVjdG9yeS1zZXJ2aWNlL2NvbXBvbmVudHMvbGRhcC9sZGFwLmNvbXBvbmVudC5zcGVjLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQ0EsMERBQXlFO0FBQ3pFLDBDQUFxRDtBQUNyRCw4REFBb0U7QUFDcEUsaURBQXlGO0FBQ3pGLCtCQUEwQjtBQUMxQiwwRUFBMEU7QUFDMUUsNEVBQWtFO0FBQ2xFLHNGQUErRjtBQUMvRiw4REFBbUU7QUFHbkUsc0VBQWtFO0FBQ2xFLHVHQUFpRztBQUNqRywyR0FBb0c7QUFDcEcseUtBRXFIO0FBQ3JILHdGQUFtRjtBQUNuRixxRkFBaUY7QUFDakYsK0ZBQTJGO0FBQzNGLDBFQUFvRTtBQUNwRSxnRkFBMkU7QUFDM0Usd0RBQTJEO0FBRTNELFFBQVEsQ0FBQyxlQUFlLEVBQUUsR0FBRyxFQUFFO0lBQzdCLElBQUksU0FBbUMsQ0FBQztJQUN4QyxJQUFJLE1BQXFCLENBQUM7SUFDMUIsSUFBSSxJQUFtQixDQUFDO0lBQ3hCLE1BQU0sa0JBQWtCLEdBQUc7UUFDekIsUUFBUSxFQUFFLENBQUMsa0JBQWtCLEVBQUUsa0JBQWtCLENBQUM7UUFDbEQsTUFBTSxFQUFFLGdCQUFnQjtRQUN4QixNQUFNLEVBQUUsb0JBQW9CO1FBQzVCLE1BQU0sRUFBRSxVQUFVO1FBQ2xCLE1BQU0sRUFBRSxJQUFJO1FBQ1osUUFBUSxFQUFFLEtBQUs7UUFDZixHQUFHLEVBQUUsV0FBVztRQUNoQixXQUFXLEVBQUUsQ0FBQztRQUNkLHFCQUFxQixFQUFFLElBQUk7UUFDM0IscUJBQXFCLEVBQUUsSUFBSTtRQUMzQixjQUFjLEVBQUUsQ0FBQztRQUNqQixrQkFBa0IsRUFBRSxZQUFZO1FBQ2hDLE9BQU8sRUFBRSxFQUFFO1FBQ1gsV0FBVyxFQUFFLEVBQUU7UUFDZixvQkFBb0IsRUFBRSxVQUFVO1FBQ2hDLE1BQU0sRUFBRSxTQUFTO0tBQ0osQ0FBQztJQUVoQixN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UyxDQUFDLE1BQU0sQ0FBQyw4QkFBYSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUNyRSxNQUFNLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyw4QkFBWSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUNsRSxDQUFDLENBQUEsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21hY2Jvb2sva2FycG92LXdvcmsvVHJ1ZU5BUy93ZWJ1aS9zcmMvYXBwL3BhZ2VzL2RpcmVjdG9yeS1zZXJ2aWNlL2NvbXBvbmVudHMvbGRhcC9sZGFwLmNvbXBvbmVudC5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEhhcm5lc3NMb2FkZXIgfSBmcm9tICdAYW5ndWxhci9jZGsvdGVzdGluZyc7XG5pbXBvcnQgeyBUZXN0YmVkSGFybmVzc0Vudmlyb25tZW50IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3Rlc3RpbmcvdGVzdGJlZCc7XG5pbXBvcnQgeyBSZWFjdGl2ZUZvcm1zTW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgTWF0QnV0dG9uSGFybmVzcyB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2J1dHRvbi90ZXN0aW5nJztcbmltcG9ydCB7IGNyZWF0ZUNvbXBvbmVudEZhY3RvcnksIG1vY2tQcm92aWRlciwgU3BlY3RhdG9yIH0gZnJvbSAnQG5nbmVhdC9zcGVjdGF0b3IvamVzdCc7XG5pbXBvcnQgeyBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmFrZVN1Y2Nlc3NmdWxKb2IgfSBmcm9tICdhcHAvY29yZS90ZXN0aW5nL3V0aWxzL2Zha2Utam9iLnV0aWxzJztcbmltcG9ydCB7IG1vY2tBdXRoIH0gZnJvbSAnYXBwL2NvcmUvdGVzdGluZy91dGlscy9tb2NrLWF1dGgudXRpbHMnO1xuaW1wb3J0IHsgbW9ja0NhbGwsIG1vY2tKb2IsIG1vY2tXZWJTb2NrZXQgfSBmcm9tICdhcHAvY29yZS90ZXN0aW5nL3V0aWxzL21vY2std2Vic29ja2V0LnV0aWxzJztcbmltcG9ydCB7IGhlbHB0ZXh0TGRhcCB9IGZyb20gJ2FwcC9oZWxwdGV4dC9kaXJlY3Rvcnktc2VydmljZS9sZGFwJztcbmltcG9ydCB7IEtlcmJlcm9zUmVhbG0gfSBmcm9tICdhcHAvaW50ZXJmYWNlcy9rZXJiZXJvcy1yZWFsbS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgTGRhcENvbmZpZyB9IGZyb20gJ2FwcC9pbnRlcmZhY2VzL2xkYXAtY29uZmlnLmludGVyZmFjZSc7XG5pbXBvcnQgeyBEaWFsb2dTZXJ2aWNlIH0gZnJvbSAnYXBwL21vZHVsZXMvZGlhbG9nL2RpYWxvZy5zZXJ2aWNlJztcbmltcG9ydCB7IEl4U2xpZGVJblJlZiB9IGZyb20gJ2FwcC9tb2R1bGVzL2Zvcm1zL2l4LWZvcm1zL2NvbXBvbmVudHMvaXgtc2xpZGUtaW4vaXgtc2xpZGUtaW4tcmVmJztcbmltcG9ydCB7IFNMSURFX0lOX0RBVEEgfSBmcm9tICdhcHAvbW9kdWxlcy9mb3Jtcy9peC1mb3Jtcy9jb21wb25lbnRzL2l4LXNsaWRlLWluL2l4LXNsaWRlLWluLnRva2VuJztcbmltcG9ydCB7XG4gIFdpdGhNYW5hZ2VDZXJ0aWZpY2F0ZXNMaW5rQ29tcG9uZW50LFxufSBmcm9tICdhcHAvbW9kdWxlcy9mb3Jtcy9peC1mb3Jtcy9jb21wb25lbnRzL3dpdGgtbWFuYWdlLWNlcnRpZmljYXRlcy1saW5rL3dpdGgtbWFuYWdlLWNlcnRpZmljYXRlcy1saW5rLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBJeEZvcm1IYXJuZXNzIH0gZnJvbSAnYXBwL21vZHVsZXMvZm9ybXMvaXgtZm9ybXMvdGVzdGluZy9peC1mb3JtLmhhcm5lc3MnO1xuaW1wb3J0IHsgU25hY2tiYXJTZXJ2aWNlIH0gZnJvbSAnYXBwL21vZHVsZXMvc25hY2tiYXIvc2VydmljZXMvc25hY2tiYXIuc2VydmljZSc7XG5pbXBvcnQgeyBMZGFwQ29tcG9uZW50IH0gZnJvbSAnYXBwL3BhZ2VzL2RpcmVjdG9yeS1zZXJ2aWNlL2NvbXBvbmVudHMvbGRhcC9sZGFwLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBJeFNsaWRlSW5TZXJ2aWNlIH0gZnJvbSAnYXBwL3NlcnZpY2VzL2l4LXNsaWRlLWluLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3lzdGVtR2VuZXJhbFNlcnZpY2UgfSBmcm9tICdhcHAvc2VydmljZXMvc3lzdGVtLWdlbmVyYWwuc2VydmljZSc7XG5pbXBvcnQgeyBXZWJTb2NrZXRTZXJ2aWNlIH0gZnJvbSAnYXBwL3NlcnZpY2VzL3dzLnNlcnZpY2UnO1xuXG5kZXNjcmliZSgnTGRhcENvbXBvbmVudCcsICgpID0+IHtcbiAgbGV0IHNwZWN0YXRvcjogU3BlY3RhdG9yPExkYXBDb21wb25lbnQ+O1xuICBsZXQgbG9hZGVyOiBIYXJuZXNzTG9hZGVyO1xuICBsZXQgZm9ybTogSXhGb3JtSGFybmVzcztcbiAgY29uc3QgZXhpc3RpbmdMZGFwQ29uZmlnID0ge1xuICAgIGhvc3RuYW1lOiBbJ2xkYXAudHJ1ZW5hcy5jb20nLCAnbGRhcC5mcmVlbmFzLm9yZyddLFxuICAgIGJhc2VkbjogJ2RjPXRlc3QsZGM9b3JnJyxcbiAgICBiaW5kZG46ICdjbj1NYW5hZ2VyLGRjPXRlc3QnLFxuICAgIGJpbmRwdzogJzEyMzQ1Njc4JyxcbiAgICBlbmFibGU6IHRydWUsXG4gICAgYW5vbmJpbmQ6IGZhbHNlLFxuICAgIHNzbDogJ1NUQVJUX1RMUycsXG4gICAgY2VydGlmaWNhdGU6IDEsXG4gICAgdmFsaWRhdGVfY2VydGlmaWNhdGVzOiB0cnVlLFxuICAgIGRpc2FibGVfZnJlZW5hc19jYWNoZTogdHJ1ZSxcbiAgICBrZXJiZXJvc19yZWFsbTogMSxcbiAgICBrZXJiZXJvc19wcmluY2lwYWw6ICdwcmluY2lwYWwxJyxcbiAgICB0aW1lb3V0OiAxMCxcbiAgICBkbnNfdGltZW91dDogMTUsXG4gICAgYXV4aWxpYXJ5X3BhcmFtZXRlcnM6ICdwYXJhbT0yNScsXG4gICAgc2NoZW1hOiAnUkZDMjMwNycsXG4gIH0gYXMgTGRhcENvbmZpZztcblxuICBjb25zdCBjcmVhdGVDb21wb25lbnQgPSBjcmVhdGVDb21wb25lbnRGYWN0b3J5KHtcbiAgICBjb21wb25lbnQ6IExkYXBDb21wb25lbnQsXG4gICAgaW1wb3J0czogW1xuICAgICAgUmVhY3RpdmVGb3Jtc01vZHVsZSxcbiAgICAgIFdpdGhNYW5hZ2VDZXJ0aWZpY2F0ZXNMaW5rQ29tcG9uZW50LFxuICAgIF0sXG4gICAgcHJvdmlkZXJzOiBbXG4gICAgICBtb2NrV2ViU29ja2V0KFtcbiAgICAgICAgbW9ja0pvYignbGRhcC51cGRhdGUnLCBmYWtlU3VjY2Vzc2Z1bEpvYigpKSxcbiAgICAgICAgbW9ja0NhbGwoJ2xkYXAuY29uZmlnJywgZXhpc3RpbmdMZGFwQ29uZmlnKSxcbiAgICAgICAgbW9ja0NhbGwoJ2tlcmJlcm9zLmtleXRhYi5rZXJiZXJvc19wcmluY2lwYWxfY2hvaWNlcycsIFtcbiAgICAgICAgICAncHJpbmNpcGFsMScsICdwcmluY2lwYWwyJyxcbiAgICAgICAgXSksXG4gICAgICAgIG1vY2tDYWxsKCdsZGFwLnNzbF9jaG9pY2VzJywgWydPRkYnLCAnU1RBUlRfVExTJ10pLFxuICAgICAgICBtb2NrQ2FsbCgnbGRhcC5zY2hlbWFfY2hvaWNlcycsIFsnUkZDMjMwNycsICdSRkMyMzA3QklTJ10pLFxuICAgICAgICBtb2NrQ2FsbCgna2VyYmVyb3MucmVhbG0ucXVlcnknLCBbXG4gICAgICAgICAgeyBpZDogMSwgcmVhbG06ICdSZWFsbSAxJyB9LFxuICAgICAgICAgIHsgaWQ6IDIsIHJlYWxtOiAnUmVhbG0gMicgfSxcbiAgICAgICAgXSBhcyBLZXJiZXJvc1JlYWxtW10pLFxuICAgICAgXSksXG4gICAgICBtb2NrUHJvdmlkZXIoSXhTbGlkZUluU2VydmljZSksXG4gICAgICBtb2NrUHJvdmlkZXIoU3lzdGVtR2VuZXJhbFNlcnZpY2UsIHtcbiAgICAgICAgcmVmcmVzaERpclNlcnZpY2VzQ2FjaGU6IGplc3QuZm4oKCkgPT4gb2YobnVsbCkpLFxuICAgICAgICBnZXRDZXJ0aWZpY2F0ZXM6ICgpID0+IG9mKFtcbiAgICAgICAgICB7IGlkOiAxLCBuYW1lOiAnY2VydGlmaWNhdGUxJyB9LFxuICAgICAgICAgIHsgaWQ6IDIsIG5hbWU6ICdjZXJ0aWZpY2F0ZTInIH0sXG4gICAgICAgIF0pLFxuICAgICAgfSksXG4gICAgICBtb2NrUHJvdmlkZXIoRGlhbG9nU2VydmljZSwge1xuICAgICAgICBqb2JEaWFsb2c6IGplc3QuZm4oKCkgPT4gKHtcbiAgICAgICAgICBhZnRlckNsb3NlZDogKCkgPT4gb2YobnVsbCksXG4gICAgICAgIH0pKSxcbiAgICAgIH0pLFxuICAgICAgbW9ja1Byb3ZpZGVyKFNuYWNrYmFyU2VydmljZSksXG4gICAgICBtb2NrUHJvdmlkZXIoSXhTbGlkZUluUmVmKSxcbiAgICAgIG1vY2tBdXRoKCksXG4gICAgICB7IHByb3ZpZGU6IFNMSURFX0lOX0RBVEEsIHVzZVZhbHVlOiB1bmRlZmluZWQgfSxcbiAgICBdLFxuICB9KTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBzcGVjdGF0b3IgPSBjcmVhdGVDb21wb25lbnQoKTtcbiAgICBsb2FkZXIgPSBUZXN0YmVkSGFybmVzc0Vudmlyb25tZW50LmxvYWRlcihzcGVjdGF0b3IuZml4dHVyZSk7XG4gICAgZm9ybSA9IGF3YWl0IGxvYWRlci5nZXRIYXJuZXNzKEl4Rm9ybUhhcm5lc3MpO1xuICB9KTtcblxuICBpdCgnbG9hZHMgTERBUCBjb25maWcgYW5kIHNob3dzIGl0JywgYXN5bmMgKCkgPT4ge1xuICAgIGV4cGVjdChzcGVjdGF0b3IuaW5qZWN0KFdlYlNvY2tldFNlcnZpY2UpLmNhbGwpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdsZGFwLmNvbmZpZycpO1xuXG4gICAgY29uc3QgdmFsdWVzID0gYXdhaXQgZm9ybS5nZXRWYWx1ZXMoKTtcbiAgICBleHBlY3QodmFsdWVzKS50b0VxdWFsKHtcbiAgICAgIEhvc3RuYW1lOiBbJ2xkYXAudHJ1ZW5hcy5jb20nLCAnbGRhcC5mcmVlbmFzLm9yZyddLFxuICAgICAgJ0Jhc2UgRE4nOiAnZGM9dGVzdCxkYz1vcmcnLFxuICAgICAgJ0JpbmQgRE4nOiAnY249TWFuYWdlcixkYz10ZXN0JyxcbiAgICAgICdCaW5kIFBhc3N3b3JkJzogJzEyMzQ1Njc4JyxcbiAgICAgIEVuYWJsZTogdHJ1ZSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3dzIGFkdmFuY2VkIExEQVAgd2hlbiBBZHZhbmNlZCBNb2RlIGlzIHByZXNzZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgYWR2YW5jZWRNb2RlQnV0dG9uID0gYXdhaXQgbG9hZGVyLmdldEhhcm5lc3MoTWF0QnV0dG9uSGFybmVzcy53aXRoKHsgdGV4dDogJ0FkdmFuY2VkIE9wdGlvbnMnIH0pKTtcbiAgICBhd2FpdCBhZHZhbmNlZE1vZGVCdXR0b24uY2xpY2soKTtcblxuICAgIGNvbnN0IHZhbHVlcyA9IGF3YWl0IGZvcm0uZ2V0VmFsdWVzKCk7XG4gICAgZXhwZWN0KHZhbHVlcykudG9FcXVhbCh7XG4gICAgICBIb3N0bmFtZTogWydsZGFwLnRydWVuYXMuY29tJywgJ2xkYXAuZnJlZW5hcy5vcmcnXSxcbiAgICAgICdCYXNlIEROJzogJ2RjPXRlc3QsZGM9b3JnJyxcbiAgICAgICdCaW5kIEROJzogJ2NuPU1hbmFnZXIsZGM9dGVzdCcsXG4gICAgICAnQmluZCBQYXNzd29yZCc6ICcxMjM0NTY3OCcsXG4gICAgICBFbmFibGU6IHRydWUsXG5cbiAgICAgICdBbGxvdyBBbm9ueW1vdXMgQmluZGluZyc6IGZhbHNlLFxuICAgICAgJ0VuY3J5cHRpb24gTW9kZSc6ICdTVEFSVF9UTFMnLFxuICAgICAgQ2VydGlmaWNhdGU6ICdjZXJ0aWZpY2F0ZTEnLFxuICAgICAgJ1ZhbGlkYXRlIENlcnRpZmljYXRlcyc6IHRydWUsXG4gICAgICAnRGlzYWJsZSBMREFQIFVzZXIvR3JvdXAgQ2FjaGUnOiB0cnVlLFxuXG4gICAgICAnS2VyYmVyb3MgUmVhbG0nOiAnUmVhbG0gMScsXG4gICAgICAnS2VyYmVyb3MgUHJpbmNpcGFsJzogJ3ByaW5jaXBhbDEnLFxuICAgICAgJ0xEQVAgVGltZW91dCc6ICcxMCcsXG4gICAgICAnRE5TIFRpbWVvdXQnOiAnMTUnLFxuICAgICAgJ0F1eGlsaWFyeSBQYXJhbWV0ZXJzJzogJ3BhcmFtPTI1JyxcbiAgICAgIFNjaGVtYTogJ1JGQzIzMDcnLFxuICAgIH0pO1xuICB9KTtcblxuICBpdCgncmVidWlsZHMgY2FjaGUgd2hlbiBSZWJ1aWxkIENhY2hlIGJ1dHRvbiBpcyBwcmVzc2VkJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlYnVpbGRDYWNoZUJ1dHRvbiA9IGF3YWl0IGxvYWRlci5nZXRIYXJuZXNzKE1hdEJ1dHRvbkhhcm5lc3Mud2l0aCh7IHRleHQ6ICdSZWJ1aWxkIERpcmVjdG9yeSBTZXJ2aWNlIENhY2hlJyB9KSk7XG4gICAgYXdhaXQgcmVidWlsZENhY2hlQnV0dG9uLmNsaWNrKCk7XG5cbiAgICBleHBlY3Qoc3BlY3RhdG9yLmluamVjdChTeXN0ZW1HZW5lcmFsU2VydmljZSkucmVmcmVzaERpclNlcnZpY2VzQ2FjaGUpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICBleHBlY3Qoc3BlY3RhdG9yLmluamVjdChTbmFja2JhclNlcnZpY2UpLnN1Y2Nlc3MpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgaGVscHRleHRMZGFwLmxkYXBfY3VzdGFjdGlvbnNfY2xlYXJjYWNoZV9kaWFsb2dfbWVzc2FnZSxcbiAgICApO1xuICB9KTtcblxuICBpdCgnc2F2ZXMgTERBUCBjb25maWcgd2hlbiBmb3JtIGlzIHN1Ym1pdHRlZCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBhZHZhbmNlZE1vZGVCdXR0b24gPSBhd2FpdCBsb2FkZXIuZ2V0SGFybmVzcyhNYXRCdXR0b25IYXJuZXNzLndpdGgoeyB0ZXh0OiAnQWR2YW5jZWQgT3B0aW9ucycgfSkpO1xuICAgIGF3YWl0IGFkdmFuY2VkTW9kZUJ1dHRvbi5jbGljaygpO1xuXG4gICAgYXdhaXQgZm9ybS5maWxsRm9ybSh7XG4gICAgICAnQmluZCBQYXNzd29yZCc6ICdhZG1pbmFkbWluJyxcbiAgICAgICdBbGxvdyBBbm9ueW1vdXMgQmluZGluZyc6IHRydWUsXG4gICAgICAnS2VyYmVyb3MgUHJpbmNpcGFsJzogJ3ByaW5jaXBhbDInLFxuICAgIH0pO1xuXG4gICAgY29uc3Qgc2F2ZUJ1dHRvbiA9IGF3YWl0IGxvYWRlci5nZXRIYXJuZXNzKE1hdEJ1dHRvbkhhcm5lc3Mud2l0aCh7IHRleHQ6ICdTYXZlJyB9KSk7XG4gICAgYXdhaXQgc2F2ZUJ1dHRvbi5jbGljaygpO1xuXG4gICAgZXhwZWN0KHNwZWN0YXRvci5pbmplY3QoV2ViU29ja2V0U2VydmljZSkuam9iKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICdsZGFwLnVwZGF0ZScsXG4gICAgICBbe1xuICAgICAgICAuLi5leGlzdGluZ0xkYXBDb25maWcsXG4gICAgICAgIGJpbmRwdzogJ2FkbWluYWRtaW4nLFxuICAgICAgICBhbm9uYmluZDogdHJ1ZSxcbiAgICAgICAga2VyYmVyb3NfcHJpbmNpcGFsOiAncHJpbmNpcGFsMicsXG4gICAgICB9XSxcbiAgICApO1xuICAgIGV4cGVjdChzcGVjdGF0b3IuaW5qZWN0KERpYWxvZ1NlcnZpY2UpLmpvYkRpYWxvZykudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIGV4cGVjdChzcGVjdGF0b3IuaW5qZWN0KEl4U2xpZGVJblJlZikuY2xvc2UpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==